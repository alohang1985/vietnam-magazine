name: CI Cron - Daily pipeline & Publish

on:
  schedule:
    # Runs at 00:00 UTC => 07:00 Asia/Ho_Chi_Minh (UTC+7)
    - cron: '0 0 * * *'

jobs:
  daily_pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install deps
        run: |
          cd apps/strapi-cms
          npm ci
      - name: Run daily pipeline
        env:
          CMS_URL: ${{ secrets.CMS_URL }}
          CMS_ADMIN_TOKEN: ${{ secrets.CMS_ADMIN_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_API_KEY: ${{ secrets.UNSPLASH_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          SEARCH_API_KEY: ${{ secrets.SEARCH_API_KEY }}
        run: |
          cd apps/strapi-cms
          node scripts/daily_pipeline.js

  publish_job:
    runs-on: ubuntu-latest
    # This uses the PUBLISH_TIME secret to compute schedule; Actions does not support dynamic schedules per secret.
    # As a workaround, run this daily and the script will check current time vs PUBLISH_TIME and exit if not matched.
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install deps
        run: |
          cd apps/strapi-cms
          npm ci
      - name: Run publish job
        env:
          CMS_URL: ${{ secrets.CMS_URL }}
          CMS_ADMIN_TOKEN: ${{ secrets.CMS_ADMIN_TOKEN }}
          PUBLISH_TIME: ${{ secrets.PUBLISH_TIME }}
          TIMEZONE: ${{ secrets.TIMEZONE }}
        run: |
          cd apps/strapi-cms
          node -e "const t=process.env.PUBLISH_TIME||'09:30'; const tz=process.env.TIMEZONE||'Asia/Ho_Chi_Minh'; const [h,m]=t.split(':').map(Number); const now=new Date().toLocaleString('en-US',{timeZone:tz}); const d=new Date(now); if (d.getHours()===h && d.getMinutes()===m){ require('./publish_job').run().catch(e=>{console.error(e); process.exit(1)});} else { console.log('Not PUBLISH_TIME yet; exiting.'); }"
