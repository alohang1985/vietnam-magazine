<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DK Command Center</title>
  <style>
    :root{--bg:#ffffff;--teal:#2a9d8f;--navy:#1a1a2e;--muted:#666}
    body{margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;background:var(--bg);color:var(--navy)}
    .wrap{display:grid;grid-template-columns:360px 1fr;grid-template-rows:1fr auto;gap:18px;height:100vh;padding:18px;box-sizing:border-box}
    .panel{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(26,26,46,0.06);padding:18px;overflow:auto}
    .left{display:flex;flex-direction:column;gap:12px}
    .right{display:flex;flex-direction:column;gap:12px}
    .hero{background:var(--navy);color:#fff;padding:18px;border-radius:12px}
    .badge{background:var(--teal);color:#fff;padding:6px 10px;border-radius:999px;font-weight:700}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btn{background:var(--teal);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted)}
    .task-list{list-style:none;padding:0;margin:0}
    .task-list li{padding:8px;border-bottom:1px solid #f3f3f3}
    .footer{grid-column:1/-1}
    textarea{width:100%;height:100px}
    @media(max-width:900px){ .wrap{grid-template-columns:1fr;grid-template-rows:auto auto 1fr auto} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel left">
      <div class="hero">
        <h2>DK Command Center</h2>
        <div class="muted">Mac Mini · Local Control Tower</div>
      </div>

      <div class="panel">
        <h3>상태 모니터</h3>
        <div id="status-monitor">로딩 중...</div>
      </div>

      <div class="panel">
        <h3>달력</h3>
        <div id="calendar-controls" style="margin-bottom:8px">
          <input id="cal-date" type="date" />
          <input id="cal-text" placeholder="일정 내용" style="width:60%;padding:6px;margin-left:8px" />
          <button id="cal-add" class="btn" style="margin-left:8px">추가</button>
        </div>
        <div id="calendar">(달력 위젯)</div>
      </div>

      <div class="panel">
        <h3>할일</h3>
        <ul id="todo" class="task-list"></ul>
        <input id="todo-input" placeholder="할일 추가" /> <button id="todo-add" class="btn">추가</button>
      </div>
    </div>

    <div class="panel right">
      <h3>OpenClaw 작업 지시</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <select id="task-select"></select>
        <button id="preview" class="btn">미리보기</button>
        <button id="exec" class="btn">OpenClaw 복사 & 열기</button>
      </div>
      <div id="cmd-preview" style="background:#fafafa;padding:10px;border-radius:8px;border:1px solid #f0f0f0;min-height:40px"></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <input id="free-input" placeholder="자유 명령 입력 (OpenClaw 프롬프트)" style="flex:1;padding:8px" />
        <button id="free-run" class="btn">복사 & 열기</button>
      </div>
      <div id="toast" style="position:fixed;top:20px;right:20px;padding:12px 16px;background:var(--teal);color:#fff;border-radius:8px;display:none">복사됨</div>

      <h4>실행 로그</h4>
      <div id="logs" style="height:300px;overflow:auto;background:#fff;border-radius:8px;padding:8px;border:1px solid #eee"></div>

      <h4>최근 작업</h4>
      <div id="recent">없음</div>
    </div>

    <div class="panel footer">
      <h3>빠른 메모</h3>
      <textarea id="quick-note"></textarea>
      <div style="margin-top:8px"><button id="save-note" class="btn">저장</button></div>
    </div>
  </div>

  <script>
    async function loadTasks(){
      const res = await fetch('/api/tasks'); const tasks = await res.json();
      const sel = document.getElementById('task-select'); sel.innerHTML = '';
      tasks.forEach(t=>{ const o = document.createElement('option'); o.value = t.prompt || t.cmd || ''; o.textContent = t.name + ' ('+t.category+')'; sel.appendChild(o); });
    }

    async function loadTodo(){ const res = await fetch('/api/todo'); const todos = await res.json(); const ul = document.getElementById('todo'); ul.innerHTML=''; todos.forEach((td,i)=>{ const li=document.createElement('li'); li.textContent = (td.done? '✅ ':'') + td.text; const btnDone=document.createElement('button'); btnDone.textContent='완료'; btnDone.style.marginLeft='8px'; btnDone.onclick=async ()=>{ await fetch('/api/todo/'+i+'/done',{method:'POST'}); loadTodo(); }; const btnDel=document.createElement('button'); btnDel.textContent='삭제'; btnDel.style.marginLeft='8px'; btnDel.onclick=async ()=>{ if(!confirm('삭제하시겠습니까?')) return; await fetch('/api/todo/'+i,{method:'DELETE'}); loadTodo(); }; li.appendChild(btnDone); li.appendChild(btnDel); ul.appendChild(li); }); }
    document.getElementById('todo-add').addEventListener('click', async ()=>{ const v=document.getElementById('todo-input').value; if(!v) return; await fetch('/api/todo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:v})}); document.getElementById('todo-input').value=''; loadTodo(); });

    // notes
    async function loadNotes(){ const res = await fetch('/api/notes'); const notes = await res.json(); const area=document.getElementById('quick-note'); area.value = notes && notes[0] ? notes[0].text : ''; const list=document.getElementById('notes-list'); if(list){ list.innerHTML=''; notes.forEach((n,i)=>{ const wrapper=document.createElement('div'); wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.style.gap='8px'; const txt=document.createElement('input'); txt.value = n.text; txt.style.flex='1'; const saveBtn=document.createElement('button'); saveBtn.textContent='수정'; saveBtn.onclick=async ()=>{ await fetch('/api/notes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:txt.value})}); loadNotes(); }; const del=document.createElement('button'); del.textContent='삭제'; del.onclick=async ()=>{ if(!confirm('삭제?')) return; await fetch('/api/notes/'+i,{method:'DELETE'}); loadNotes(); }; wrapper.appendChild(txt); wrapper.appendChild(saveBtn); wrapper.appendChild(del); list.appendChild(wrapper); }); }}
    document.getElementById('save-note').addEventListener('click', async ()=>{ const v=document.getElementById('quick-note').value; await fetch('/api/notes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:v})}); loadNotes(); });

    // calendar
    async function loadCalendar(){ const res = await fetch('/api/calendar'); const cal = await res.json(); const el=document.getElementById('calendar'); el.innerHTML=''; cal.forEach((c,i)=>{ const d=document.createElement('div'); d.textContent = c.date + ' - ' + c.text; const del=document.createElement('button'); del.textContent='삭제'; del.style.marginLeft='8px'; del.onclick=async ()=>{ if(!confirm('삭제?')) return; await fetch('/api/calendar/'+i,{method:'DELETE'}); loadCalendar(); }; d.appendChild(del); el.appendChild(d); }); }
    document.getElementById('cal-add').addEventListener('click', async ()=>{ const date=document.getElementById('cal-date').value; const text=document.getElementById('cal-text').value; if(!date||!text) return alert('날짜와 내용을 입력하세요'); await fetch('/api/calendar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date,text})}); document.getElementById('cal-date').value=''; document.getElementById('cal-text').value=''; loadCalendar(); });
    // run preview/execute
    document.getElementById('preview').addEventListener('click', async ()=>{
      const prompt = document.getElementById('task-select').value;
      document.getElementById('cmd-preview').textContent = prompt || '없음';
    });

    async function copyAndOpen(promptText){
      try{
        await navigator.clipboard.writeText(promptText);
        const toast = document.getElementById('toast'); toast.textContent = '클립보드에 복사됨 — OpenClaw 창에서 Cmd+V 후 엔터'; toast.style.display='block'; setTimeout(()=>toast.style.display='none',4000);
        window.open('http://127.0.0.1:18789','_blank');
      }catch(e){ alert('클립보드 복사 실패: '+e.message); }
    }

    document.getElementById('exec').addEventListener('click', async ()=>{
      const prompt = document.getElementById('task-select').value;
      if(!prompt) return alert('프롬프트가 비어있습니다');
      copyAndOpen(prompt);
    });

    document.getElementById('free-run').addEventListener('click', async ()=>{
      const prompt = document.getElementById('free-input').value;
      if(!prompt) return alert('입력하세요');
      copyAndOpen(prompt);
    });

    async function showConfigStatus(){
      const res = await fetch('/api/config');
      const cfg = await res.json();
      const sm = document.getElementById('status-monitor');
      sm.innerHTML = '';
      const services = [
        { key: 'railway', label: 'Railway' },
        { key: 'strapi', label: 'Strapi' },
        { key: 'vietnam_magazine', label: 'Vietnam Magazine (Strapi)' },
        { key: 'tourpik', label: 'Tourpik' },
        { key: 'telegram', label: 'Telegram' },
        { key: 'exchange', label: '환율 API' },
        { key: 'weather', label: '날씨 API' }
      ];
      services.forEach(s => {
        const div = document.createElement('div');
        const val = cfg[s.key];
        if (!val) {
          div.innerHTML = `<strong>${s.label}:</strong> 설정 필요 — config.json에 API 키를 입력해주세요`;
        } else {
          // check required fields per service
          let ok = true; let missing = [];
          if (s.key === 'railway') { if (!val.api_token || !val.projects || !val.projects.length) { ok=false; missing.push('api_token/projects'); } }
          if (s.key === 'strapi') { if (!val.url || !val.api_token) { ok=false; missing.push('url/api_token'); } }
          if (s.key === 'vietnam_magazine') { if (!val.strapi_url) { ok=false; missing.push('strapi_url'); } }
          if (s.key === 'tourpik') { if (!val.url) { ok=false; missing.push('url'); } }
          if (s.key === 'telegram') { if (!val.bot_token || !val.chat_id) { ok=false; missing.push('bot_token/chat_id'); } }
          if (s.key === 'exchange') { if (!val.api_key) { ok=false; missing.push('api_key'); } }
          if (s.key === 'weather') { if (!val.api_key) { ok=false; missing.push('api_key'); } }
          if (!ok) div.innerHTML = `<strong>${s.label}:</strong> 설정 필요 — ${missing.join(', ')}`;
          else div.innerHTML = `<strong>${s.label}:</strong> 구성됨`; 
        }
        sm.appendChild(div);
      });
    }

    async function init(){ await loadTasks(); await loadTodo(); await loadNotes(); await loadCalendar(); await showConfigStatus(); }
    window.onload = init;
  </script>
</body>
</html>